---
title: "NHS Doctor Income vs Inflation Project"
author: "Hugo Labat"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: hpstr
  pdf_document: default
---
```{r global-options, include=FALSE}
#This sets a few defaults for this entire markdown, to make it visually constant
#and to prevent messages and warnings without retyping the command.
knitr::opts_chunk$set(fig.width=12,fig.height=8,echo=TRUE,
                      warning=FALSE,message=FALSE)
```
# Background
Text


# Aims
Text


# Setting Up
Text

```{r libraries}
#Loading all necessary libraries
library(tidyverse)
library(here)
library(pdftools)
```

# Data Origins
Text

Mention how I didn't include Jan-March 2007 data because they don't separate specialist from staff grade incomes, thus it isn't fair to compare. From April onwards they do, so I can compare them fairly.

I chose the media FTE because, by the NHS's account, it is a "more robust indicator of typical pay"

### I found that the data from 2021 contained salary breakdowns from 2010. Since I had pdf data from June 2007 until December 2008, and from August 2010 until December 2021, I needed data from March 2009 to September 2010. I found three sheets that provided this data, specifically:
Data from Jan-March 2009 until September 2012 from: https://digital.nhs.uk/data-and-information/publications/statistical/nhs-staff-earnings-estimates/nhs-staff-earnings-estimates-to-september-2012

Data until December 2021 from:https://digital.nhs.uk/data-and-information/publications/statistical/nhs-staff-earnings-estimates/december-2021-provisional-statistics

Data from June 2007 to December 2008, from various links (pdf data)

### Talk about how the data from 2009 to 2010 is inevitably 

### Thus best to compare data from August 2010 onwards
```{r data}

```



# Data Preparation

I created a function that would extract the required data from the 7 pdf files of 2007-2008. It would have been faster to extract the information by hand, but I enjoyed the challenge and I learned a new skill.

```{r preparation pdfs, message=TRUE}
#Creating function to extract salary data from .pdf file
pdf_extract <- function(raw){
  
  #Splits single pages
  raw <- map(raw,~str_split(.x,"\\n") %>% unlist())
  
  #Concatenate split pages
  raw <- reduce(raw,c)
  
  #Specifying start and end of desired table
  table_start <- stringr::str_which(tolower(raw),"foundation yr 1")-1
  table_end <- stringr::str_which(tolower(raw),"source")-1
  table_end <- table_end[min(which(table_end>table_start))] #this is to make sure I get the right table
  
  #Creating a table & removing the special characters
  table <- raw[(table_start):(table_end)]
  table <- table %>% str_replace_all("\\s{2,}","|") %>%
    str_replace_all("Â£","") %>% 
    str_replace_all(",","")
  text_con <- textConnection(table)
  data_table <- read.csv(text_con,sep="|")
  
  #Extracting desired column and making numerical
  data_table <- data_table[c(1,4)]
  data_table <- data_table %>% transform(Salary.3=as.numeric(Salary.3))
  
  #Merging consultant role salaries into one row; they occupy rows 4&5
  data_table[c(4,5),2] <- mean(data_table[c(4,5),2])
  data_table <- data.frame(data_table[c(1:4,6:7),c(1,2)])
  
  #Renaming the rows to be code-friendly
  data_table[1] <- c("fy1","fy2","reg","con","spec","staff")

  #outputting end data frame, so it is use-able by map_df
  data_table
  #end of function
}


#Creating a vector that contains a list of all the files in my pdf folder
pdf_list <- list.files(here("data","raw","pdf"))

#creating df as a master df for all data from all pdfs
pdf_data <- data.frame(role=c("fy1","fy2","reg","con","spec","staff"))

#For loop that works through the pdf files in my raw data
for (i in c(1:length(pdf_list))){
  
  #Extracting pdf from folder and turns it into a string of text
  raw_table <- map(here("data","raw","pdf",pdf_list[i]),pdf_text)
  
  #Applying pdf_extract function on raw data
  data_table <- map_df(raw_table,pdf_extract)
  
  #Adding the looped data_table to pdf_data
  pdf_data[,i+1] <- data_table[,2]
  
  #changing the column names to match the data
  colnames(pdf_data)[i+1] <- sub(".pdf","",pdf_list[i])
}

#Saving data to 'refined' data folder
write.csv(pdf_data,here("data","refined","pdf_data.csv"),row.names=TRUE)
```
I 

Explanation of the groups I want to filter in
#These are Consultant, Speciality Registrar, Core Training, FY1, and FY2 staff groups
#These are the training posts or end-of-training post (consultant), so are relevant to most doctors
# Mention why there is a dip in pay during August despite the CIPH not changing
# Mention why not using splitLayout

To get an idea of the methods/data/etc used, you can find the repository for this project by [clicking here](https://github.com/hvlabat/nhs_income_vs_inflation).