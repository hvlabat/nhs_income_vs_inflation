---
title: "NHS Doctor Income vs Inflation Project"
author: "Hugo Labat"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: hpstr
  pdf_document: default
---
```{r global-options, include=FALSE}
#This sets a few defaults for this entire markdown, to make it visually constant
#and to prevent messages and warnings without retyping the command.
knitr::opts_chunk$set(fig.width=12,fig.height=8,echo=TRUE,
                      warning=FALSE,message=FALSE)
```
# Background
Text


# Aims
Text



# Test Plots

```{r test_plots}
#Loading all necessary libraries
library(tidyverse)
library(here)
library(scales)

#Extracting required data into data frame
mean_salary_change_df <- read_csv(here("data","refined","mean_salary_change.csv"))
cpih_df <- read_csv(here("data","refined","cpih_data.csv"))
salary_change_df <- read_csv(here("data","refined","salary_change.csv"))

#Removing useless columns in all dfs
mean_salary_change_df <- mean_salary_change_df[,-1]
cpih_df <- cpih_df[,-1]
salary_change_df <- salary_change_df[,-1]

#Reformatting cpih so that the index starts at 0, to match salary change dfs
cpih_df$cpih <- cpih_df$cpih-100

#Creating a cpih df to be compatible with all groups of salary_change_df
for (i in c(1:5)){
  if (i==1){
    cpih_all_groups <- cpih_df
  }
  else{
    cpih_all_groups <- rbind(cpih_all_groups,cpih_df)
  }
}


#First Data-Wrangling & Visualisation:
#Comparing mean salary data with cpih data

#Merging mean data and cpih data & removing superfluous date column
cpih_vs_mean_salary <- cbind(mean_salary_change_df,cpih_df)
cpih_vs_mean_salary <- cpih_vs_mean_salary[,-3]

#Calculating difference between cpih and mean salary change
cpih_vs_mean_salary$diff <- cpih_vs_mean_salary$mean_salary_change-cpih_vs_mean_salary$cpih

#Plotting the difference
p_mean_diff <- ggplot(cpih_vs_mean_salary,aes(x=date,y=diff))

p_mean_diff+geom_line()+geom_smooth(method="gam")



#Second Data-Wrangling & Visualisation:
#Calculating effective money gained/lost from beginning to end of time sequence
#For average income of all doctors

#The comparison income will be the mean income per month of all doctors
mean_income <- mean(salary_change_df$amount)

#Altering cpih_vs_mean_salary to include a column with cumulative income change
for (i in c(1:nrow(cpih_vs_mean_salary))){
  if (i==1){
    cpih_vs_mean_salary$cumulative_income_change[1] <- 0 #set baseline
  }
  else{
    cpih_vs_mean_salary$cumulative_income_change[i] <- 
      (mean_income*(cpih_vs_mean_salary$diff[i]/100))+
      cpih_vs_mean_salary$cumulative_income_change[i-1]
  }
}

#Changing data to represent cumulative income lost due to inflation
cpih_vs_mean_salary$cumulative_income_lost <- -cpih_vs_mean_salary$cumulative_income_change

#Plotting the above, with changes to make the plot aesthetically pleasing
p_mean_cumulative <- ggplot(cpih_vs_mean_salary,aes(x=date,y=cumulative_income_lost))

p_mean_cumulative+geom_line(colour="steelblue",size=1)+
  scale_y_continuous(labels=dollar_format(prefix="£"),
                     breaks=seq(0,30000,5000),
                     minor_breaks=seq(-1000,31000,1000),
                     limits=c(-1000,30000),
                     expand=c(0,0))+
  scale_x_date(date_breaks="1 year",
               date_labels="%Y",
               limits=as.Date(c("2009-07-01","2022-07-01")),
               expand=c(0,0))+
  labs(title="Average Cumulative Income Lost to Inflation by an NHS Doctor",
       subtitle="From Sept 2009 to Dec 2021")+
  theme(plot.title=element_text(colour="steelblue"))+
  xlab("Date")+
  ylab("Cumulative Income Lost")+
  theme(axis.title.x = element_text(vjust=-0.35),
        axis.title.y = element_text(vjust=2)) #shifting axis titles to give space



#Third Data-Wrangling & Visualisation:
#Comparing per-group salary data with cpih data

#Merging all groups data and cpih data & removing superfluous date column
cpih_vs_salary <- cbind(salary_change_df,cpih_all_groups)
cpih_vs_salary <- cpih_vs_salary[,-5]

#Calculating difference between cpih and salary change
cpih_vs_salary$diff <- cpih_vs_salary$salary_change-cpih_vs_salary$cpih

#Plotting the difference
p_diff <- ggplot(cpih_vs_salary,aes(x=date,y=diff,colour=group))

p_diff+geom_line()+geom_smooth(method="gam")



#Fourth Data-Wrangling & Visualisation:
#Calculating effective money gained/lost from beginning to end of time sequence
#For each income of each doctor group

#Creating group_change to measure income lost per group, with each group being 148 long
for (i in c(1:nrow(cpih_vs_salary))){
  if (i==1){
    cpih_vs_salary$cumulative_income_lost[i] <- 0 #set beginning baseline
  }
  else if ((i-1)%%148==0){
    cpih_vs_salary$cumulative_income_lost[i] <- 0 #set baseline for each group
  }
  else{
    cpih_vs_salary$cumulative_income_lost[i] <- 
      -((mean_income*(cpih_vs_salary$diff[i]/100))-
      cpih_vs_salary$cumulative_income_lost[i-1])
  }
}

#Ordering the 'group' column in order of descending seniority (consultant->fy1)
cpih_vs_salary$group <- factor(cpih_vs_salary$group,
                               levels=c("Consultant",
                                        "Specialty Registrar",
                                        "Core Training",
                                        "Foundation Doctor Year 2",
                                        "Foundation Doctor Year 1"))

#Plotting the above, with changes to make it aesthetically pleasing
p_group_cumulative <- ggplot(cpih_vs_salary,aes(x=date,
                                                y=cumulative_income_lost,
                                                colour=group))

p_group_cumulative+
  geom_line(size=1)+
  theme_light()+
  scale_y_continuous(labels=dollar_format(prefix="£"),
                     breaks=seq(0,50000,5000),
                     minor_breaks=seq(-2000,50000,1000),
                     limits=c(-2000,48000),
                     expand=c(0,0))+
  scale_x_date(date_breaks="1 year",
               date_minor_breaks="3 months",
               date_labels="%Y",
               limits=as.Date(c("2009-07-01","2022-06-15")),
               expand=c(0,0))+
  labs(title="Cumulative Salary Lost to Inflation by NHS Doctors",
       subtitle="From Sept 2009 to Dec 2021, per Stage of Training",
       colour="Stage of Training")+
  theme(plot.title=element_text(colour="#56B4E9",size=15),
        panel.grid.major=element_line(size=1,colour="grey85"),
        panel.grid.minor=element_line(colour="grey90"),
        axis.ticks=element_line(size=1))+ #to match major grid size
  xlab("Date")+
  ylab("Cumulative Salary Loss")+
  scale_colour_manual(values=c("#E69F00",
                               "#56B4E9",
                               "#009E73",
                               "#F0E442",
                               "#D55E00"))+ #compatible for colour-blind people
  theme(axis.title.x = element_text(vjust=-0.35),
        axis.title.y = element_text(vjust=2.5)) #shifting axis titles to give space



#FIfth Data-Wrangling & Visualisation:
#Calculating how much doctors should be earning if their incomes consistently
#increased with cpih since 2009, and comparing this to present income changes

#Using cpih_change from cpih_df to calculate cpih-adjusted salary
for (i in c(1:nrow(cpih_vs_salary))){
  if (i==1){
    cpih_vs_salary$cpih_matched_salary[i] <- cpih_vs_salary$amount[i] #set beginning baseline
  }
  else if ((i-1)%%148==0){
    cpih_vs_salary$cpih_matched_salary[i] <- cpih_vs_salary$amount[i] #set baseline for each group
  }
  else{
    cpih_vs_salary$cpih_matched_salary[i] <-
      (cpih_vs_salary$cpih_matched_salary[i-1]*(cpih_vs_salary$cpih_change[i])/100)+
      cpih_vs_salary$cpih_matched_salary[i-1]
  }
}

#Using cpih_matched_salary to compare against real salary per group
ggplot()+
  geom_line(data=cpih_vs_salary,
            aes(x=date,
                y=amount,
                colour=group),
            size=1)+
  geom_line(data=cpih_vs_salary,
            aes(x=date,
                y=cpih_matched_salary,
                colour=group),
            size=1,
            linetype=2)+
  theme_light()+
  scale_y_continuous(labels=dollar_format(prefix="£"),
                     breaks=seq(2000,9000,1000),
                     minor_breaks=seq(1000,10000,250),
                     limits=c(1000,10000),
                     expand=c(0,0))+
  scale_x_date(date_breaks="1 year",
               date_minor_breaks="3 months",
               date_labels="%Y",
               limits=as.Date(c("2009-07-01","2022-06-15")),
               expand=c(0,0))+
  labs(title="Inflation-Matched Salary vs Real Salary of NHS Doctors",
       subtitle="Dashed Line = Inflation-Matched, Solid Line = Real Salary",
       colour="Stage of Training")+
  theme(plot.title=element_text(colour="#56B4E9",size=15),
        panel.grid.major=element_line(size=1,colour="grey85"),
        panel.grid.minor=element_line(colour="grey90"),
        axis.title.x = element_text(vjust=-0.35),
        axis.title.y = element_text(vjust=2.5), #shifting axis titles to give space
        axis.ticks=element_line(size=1))+ #to match major grid size
  xlab("Date")+
  ylab("Monthly Salary")+
  scale_colour_manual(values=c("#E69F00",
                               "#56B4E9",
                               "#009E73",
                               "#F0E442",
                               "#D55E00")) #compatible for colour-blind people
```

# Test Shiny App

```{r test_shiny}
#I used this to test my final shiny ui script prior to implementation


#Loading all necessary libraries
library(tidyverse)
library(here)
library(scales)
library(shiny)
library(shinyWidgets)
library(later)
library(ggpubr)


#Making the shinyApp for combined col_df and cpih_vs_salary data frames

#Creating df with columns for change, date, and groups only, adding cpih to 'group' column
col_df <- data.frame(cpih_vs_salary$date,cpih_vs_salary$group,cpih_vs_salary$salary_change)
colnames(col_df) <- c("date","group","change")

temp_cpih_df <- data.frame(cpih_vs_salary$date,cpih_vs_salary$cpih)
temp_cpih_df <- temp_cpih_df[c(1:148),]
temp_cpih_df$group <- "CPIH"
temp_cpih_df <- temp_cpih_df[,c(1,3,2)]
colnames(temp_cpih_df) <- c("date","group","change")

col_df <- rbind(col_df,temp_cpih_df)

#Creating a list of months from the 148 available
choices_month <- as.Date(col_df$date[c(1:148)])

#User Interface defined as ui, with settings as desired
ui <- fluidPage(
  titlePanel(tags$span(style="color:#56B4E9",
                       "Comparing NHS Doctor Salary to CPIH")),
  titlePanel(tags$h4("From Sept 2009 to Dec 2021")),
  wellPanel(
    sliderTextInput(inputId="date",
                    label="Select Date:",
                    choices=choices_month,
                    selected=choices_month[148],
                    animate=animationOptions(interval=800))
  ),
  mainPanel(plotOutput(outputId="plot",inline=TRUE)
  )
)

#Server function to define plot
server <- function(input,output){
  
  #Reactive expression to streamline shiny
  dataInput <- reactive({
    req(input$date)
  })
  
  #Plotting both cpih_vs_salary and col_df onto output$plot using ggarrange
  output$plot <- renderPlot({
    
    
    #Plotting cumulative salary loss, using cpih_vs_salary & geom_line
    loss_plot <- ggplot()+
      geom_line(data=cpih_vs_salary %>% filter(date<=input$date),
                aes(x=date,
                    y=cumulative_income_lost,
                    colour=group),size=1)+
      theme_light()+
      scale_y_continuous(labels=dollar_format(prefix="£"),
                         breaks=seq(0,50000,5000),
                         minor_breaks=seq(-2000,50000,1000),
                         limits=c(-2000,48000),
                         expand=c(0,0))+
      scale_x_date(date_breaks="1 year",
                   date_minor_breaks="3 months",
                   date_labels="%Y",
                   limits=as.Date(c("2009-07-01","2022-06-15")),
                   expand=c(0,0))+
      labs(title="Cumulative Salary Lost to Inflation",
           subtitle=paste("Date:",format(as.Date(input$date),"%b %Y"),"; Sept 2009 = 0"))+
      theme(plot.title=element_text(colour="#56B4E9",face="bold"),
            panel.grid.major=element_line(size=1,colour="grey85"),
            panel.grid.minor=element_line(colour="grey90"),
            axis.title.x = element_text(vjust=-0.35),
            axis.title.y = element_text(vjust=2.5),
            legend.position="none", #remove legend, since col_plot has one already
            axis.ticks=element_line(size=1))+ #to match major grid size
      xlab("Date")+
      ylab("Cumulative Salary Loss")+
      scale_colour_manual(values=c("#E69F00",
                                   "#56B4E9",
                                   "#009E73",
                                   "#F0E442",
                                   "#D55E00")) #compatible for colour-blind people
      
    
    
    #Plotting monthly % changes in salary and inflation, using col_df & geom_col
    col_plot <- ggplot()+
      geom_col(data=col_df %>% filter(date==input$date),
               aes(x=group,y=change,fill=group))+
      scale_fill_manual(values=c("#E69F00",
                                 "#56B4E9",
                                 "#009E73",
                                 "#F0E442",
                                 "#D55E00",
                                 "#888888"))+
      theme_light()+
      labs(title="Change in Salary and CPIH",
           subtitle=paste("Date:",format(as.Date(input$date),"%b %Y"),"; Sept 2009 = 0"),
           fill="Group")+
      theme(plot.title=element_text(colour="#56B4E9",face="bold"),
            panel.grid.major=element_line(size=1,colour="grey85"),
            panel.grid.minor=element_line(colour="grey90"),
            axis.ticks=element_line(size=1),
            axis.title.x = element_text(vjust=-0.35),
            axis.title.y = element_text(vjust=2.5))+
      xlab("Group")+
      ylab("Percentage Change")+
      scale_x_discrete(labels=c("CCT","ST","CT","FY2","FY1","CPIH"))+
      scale_y_continuous(limits=c(-8,38),
                         breaks=seq(-5,35,5),
                         minor_breaks=seq(-8,38,1),
                         expand=c(0,0))
    
    
    
    #Plotting real vs inflation-matched salary, using cpih_vs_salary & geom_line
    match_plot <- ggplot()+
      geom_line(data=cpih_vs_salary %>% filter(date<=input$date),
                aes(x=date,
                    y=amount,
                    colour=group),
                size=1)+
      geom_line(data=cpih_vs_salary,
                aes(x=date,
                    y=cpih_matched_salary,
                    colour=group),
                size=1,
                linetype=2)+
      theme_light()+
      scale_y_continuous(labels=dollar_format(prefix="£"),
                         breaks=seq(2000,9000,1000),
                         minor_breaks=seq(1000,10000,250),
                         limits=c(1000,10000),
                         expand=c(0,0))+
      scale_x_date(date_breaks="1 year",
                   date_minor_breaks="3 months",
                   date_labels="%Y",
                   limits=as.Date(c("2009-07-01","2022-06-15")),
                   expand=c(0,0))+
      labs(title="Inflation-Matched vs Real Salary",
           subtitle=paste("Date:",format(as.Date(input$date),"%b %Y"),
                          ";Dashed = Inflation-Matched, Solid = Real Salary"),
           colour="Stage of Training")+
      theme(plot.title=element_text(colour="#56B4E9",face="bold"),
            panel.grid.major=element_line(size=1,colour="grey85"),
            panel.grid.minor=element_line(colour="grey90"),
            axis.title.x = element_text(vjust=-0.35),
            legend.position="none", #remove legend, since col_plot has one already
            axis.title.y = element_text(vjust=2.5), #shifting axis titles to give space
            axis.ticks=element_line(size=1))+ #to match major grid size
      xlab("Date")+
      ylab("Monthly Salary")+
      scale_colour_manual(values=c("#E69F00",
                                   "#56B4E9",
                                   "#009E73",
                                   "#F0E442",
                                   "#D55E00")) #compatible for colour-blind people
    
    
    
    #Using ggarrange to merge the plots into one
    ggarrange(loss_plot,match_plot,col_plot,ncol=3,nrow=1)
  })
}

#Creating the app
shinyApp(ui,server)

```



# Setting Up
Text

```{r libraries}
#Loading all necessary libraries
library(tidyverse)
library(here)
library(pdftools)
```

# Data Origins
Text

Mention how I didn't include Jan-March 2007 data because they don't separate specialist from staff grade incomes, thus it isn't fair to compare. From April onwards they do, so I can compare them fairly.

I chose the media FTE because, by the NHS's account, it is a "more robust indicator of typical pay"

### I found that the data from 2021 contained salary breakdowns from 2010. Since I had pdf data from June 2007 until December 2008, and from August 2010 until December 2021, I needed data from March 2009 to September 2010. I found three sheets that provided this data, specifically:
Data from Jan-March 2009 until September 2012 from: https://digital.nhs.uk/data-and-information/publications/statistical/nhs-staff-earnings-estimates/nhs-staff-earnings-estimates-to-september-2012

Data until December 2021 from:https://digital.nhs.uk/data-and-information/publications/statistical/nhs-staff-earnings-estimates/december-2021-provisional-statistics

Data from June 2007 to December 2008, from various links (pdf data)

### Talk about how the data from 2009 to 2010 is inevitably 

### Thus best to compare data from August 2010 onwards
```{r data}

```



# Data Preparation

I created a function that would extract the required data from the 7 pdf files of 2007-2008. It would have been faster to extract the information by hand, but I enjoyed the challenge and I learned a new skill.

```{r preparation pdfs, message=TRUE}
#Creating function to extract salary data from .pdf file
pdf_extract <- function(raw){
  
  #Splits single pages
  raw <- map(raw,~str_split(.x,"\\n") %>% unlist())
  
  #Concatenate split pages
  raw <- reduce(raw,c)
  
  #Specifying start and end of desired table
  table_start <- stringr::str_which(tolower(raw),"foundation yr 1")-1
  table_end <- stringr::str_which(tolower(raw),"source")-1
  table_end <- table_end[min(which(table_end>table_start))] #this is to make sure I get the right table
  
  #Creating a table & removing the special characters
  table <- raw[(table_start):(table_end)]
  table <- table %>% str_replace_all("\\s{2,}","|") %>%
    str_replace_all("£","") %>% 
    str_replace_all(",","")
  text_con <- textConnection(table)
  data_table <- read.csv(text_con,sep="|")
  
  #Extracting desired column and making numerical
  data_table <- data_table[c(1,4)]
  data_table <- data_table %>% transform(Salary.3=as.numeric(Salary.3))
  
  #Merging consultant role salaries into one row; they occupy rows 4&5
  data_table[c(4,5),2] <- mean(data_table[c(4,5),2])
  data_table <- data.frame(data_table[c(1:4,6:7),c(1,2)])
  
  #Renaming the rows to be code-friendly
  data_table[1] <- c("fy1","fy2","reg","con","spec","staff")

  #outputting end data frame, so it is use-able by map_df
  data_table
  #end of function
}


#Creating a vector that contains a list of all the files in my pdf folder
pdf_list <- list.files(here("data","raw","pdf"))

#creating df as a master df for all data from all pdfs
pdf_data <- data.frame(role=c("fy1","fy2","reg","con","spec","staff"))

#For loop that works through the pdf files in my raw data
for (i in c(1:length(pdf_list))){
  
  #Extracting pdf from folder and turns it into a string of text
  raw_table <- map(here("data","raw","pdf",pdf_list[i]),pdf_text)
  
  #Applying pdf_extract function on raw data
  data_table <- map_df(raw_table,pdf_extract)
  
  #Adding the looped data_table to pdf_data
  pdf_data[,i+1] <- data_table[,2]
  
  #changing the column names to match the data
  colnames(pdf_data)[i+1] <- sub(".pdf","",pdf_list[i])
}

#Saving data to 'refined' data folder
write.csv(pdf_data,here("data","refined","pdf_data.csv"),row.names=TRUE)
```
I 

Explanation of the groups I want to filter in
#These are Consultant, Speciality Registrar, Core Training, FY1, and FY2 staff groups
#These are the training posts or end-of-training post (consultant), so are relevant to most doctors
# Mention why there is a dip in pay during August despite the CIPH not changing
# Mention why not using splitLayout

To get an idea of the methods/data/etc used, you can find the repository for this project by [clicking here](https://github.com/hvlabat/nhs_income_vs_inflation).